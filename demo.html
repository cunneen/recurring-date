<html>

<head>
  <title>Recurring Date Demo</title>
  <script type='text/javascript' src='https://code.jquery.com/jquery-1.12.4.min.js'></script>
  <script type='text/javascript'
    src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js'></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
  <script>
    // override require JS for use in browser.
    function require(libname) {
      if (libname === 'moment') {
        return moment;
      }
    }
  </script>
  <script type='text/javascript' src='lib/RecurringDate.js'></script>

  <script type='text/javascript'>
    RecurringDate.initializeWithDateLibrary(moment);

    function generate_recurrence() {
      var pattern = {
        date_format: "MM/DD/YYYY"
      };

      // gather pattern
      _(['start', 'every', 'unit', 'end_condition', 'until', 'rfor', 'nth', 'occurrence_of']).each(function (k) {
        pattern[k] = $('#' + k).val();
      });

      pattern.days = [];

      // gather selected days
      $('input.week_days').map(function (i, e) {
        if (e.checked) {
          pattern.days.push(parseInt(e.value, 10));
        }
      });

      $('#output').val('Input: \n');

      _(pattern).each(function (e, i) {
        $('#output').val($('#output').val() + '\t' + i + ': ' + e + "\n")
      });

      $('#output').val($('#output').val() + '\n');

      try {
        var r = new RecurringDate(pattern);
        var dates = r.generate(($(this).value == '') ? undefined : this.value);
      } catch (e) {
        $('#output').val(e.message);
        return;
      }

      $('#output').val($('#output').val() + "r.describe():\n\t" + r.describe() + "\n\n");

      $('#output').val($('#output').val() + 'r.generate():\n');

      // compact description. next version.
      // $('#output').val( $('#output').val() + "short:\n" + r.describe(true) + "\n\n");

      // Port it over once I can get a dates value
      /*$('#output').value += dates.collect(function(d) {
        return d.toString('ddd MM/dd/yyyy');
      }).join("\n");*/

      var dateList = _(dates).reduce(function (memo, d) {
        return memo + '\t' + d.toString('ddd MM/dd/yyyy') + "\n";
      }, '');

      $('#output').val($('#output').val() + dateList + "\n");


      $('#output').val($('#output').val() + 'includes today:\n');
      $('#output').val($('#output').val() + r.contains(Date.now()));
    }

    $(document).ready(function () {
      const start = document.querySelector('#start');
      const until = document.querySelector('#until');
      const inputFieldFormat = 'mm/dd/yyyy'
      const datepickerStart = new Datepicker(start, {
        format: inputFieldFormat
      });
      const datepickerUntil = new Datepicker(until, {
        format: inputFieldFormat
      });

      $('#end_condition').change(function () {
        $('#for_span, #until_span').hide();
        $('#' + this.value + '_span').show();
      });

      $('#unit').change(function () {
        $('#week_span, #month_span').hide();
        if (this.value == 'w') $('#week_span').show();
        if (this.value == 'm') $('#month_span').show();
      });

      $('button').click(generate_recurrence);

      generate_recurrence();
    });
  </script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5/dist/litera/bootstrap.min.css">
</head>

<body class="bg-dark">
  <div class="container mt-5">
    <div class="col-6 offset-3">

      <div class="card">
        <div class="card-header bg-success text-bg-success">
          Recurring Date Demo
        </div>
        <div class="card-body justify-content-start">
          <form>
            <div class="input-group mb-3">
              <label for="every" class="input-group-text">Every</label>
              <input id='every' class="form-control" type='text' value='2' size='2' />
              <select class="form-select" id='unit'>
                <option value='d'>day(s)</option>
                <option value='w'>week(s)</option>
                <option value='m'>month(s)</option>
                <option value='y'>year(s)</option>
              </select>
            </div>
            <div class="input-group mb-3" id='month_span' style='display:none'>

              <span class="input-group-text">on the</span>
              <select class="form-select" id='nth'>
                <option value='1'>first</option>
                <option value='2'>second</option>
                <option value='3'>third</option>
                <option value='4'>fourth</option>
                <option value='-1'>last</option>
              </select>
              <select class="form-select" id='occurrence_of'>
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
                <option value="-1">day</option>
              </select>
            </div>

            <div id='week_span' class="input-group mb-3 justify-content-evenly align-items-center" style='display:none'>
              <span class="input-group-text flex-grow-1 mr-3">on</span>
              <div class="flex-grow-1 justify-content-center ml-3">
                <div class="form-check form-check-inline">
                  <input class='week_days form-check-input' type='checkbox' value='0' id="sun">
                  <label for="sun" class="form-check-label">Sun</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class='week_days form-check-input' type='checkbox' value='1' id="mon">
                  <label for="mon" class="form-check-label">Mon</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class='week_days form-check-input' type='checkbox' value='2' id="tue">
                  <label for="tue" class="form-check-label">Tue</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class='week_days form-check-input' type='checkbox' value='3' id="wed">
                  <label for="wed" class="form-check-label">Wed</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class='week_days form-check-input' type='checkbox' value='4' id="thu">
                  <label for="thu" class="form-check-label">Thu</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class='week_days form-check-input' type='checkbox' value='5' id="fri">
                  <label for="fri" class="form-check-label">Fri</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class='week_days form-check-input' type='checkbox' value='6' id="sat">
                  <label for="sat" class="form-check-label">Sat</label>
                </div>
              </div>
            </div>

            <div class="input-group mb-3">

              <span class="input-group-text">from</span>
              <input id='start' type='text' value='1/1/2025' class="form-control" />
              <select class="form-select" id='end_condition'>
                <option>for</option>
                <option>until</option>
              </select>
            </div>
            <div class="input-group mb-3" id='for_span'>

              <span class="input-group-text">for</span>
              <input id='rfor' type='text' class="form-control" value='10' />
              <span class="input-group-text">occurences</span></span>
            </div>
            <div class="input-group mb-3" id='until_span' style='display:none'>
              <span class="input-group-text">until </span>
              <input id='until' type='text' value='12/31/2025' />
            </div>
            <div class="mb-3 text-center">
              <button type="button" class="btn btn-primary m-1">Generate all</button>
              <button type="button" class="btn btn-primary m-1" value='10'>Generate sample (10)</button>
            </div>

            <div class="mb-3 ">
              <textarea id='output' class="form-control" rows="10"></textarea>
              </p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker.min.js"></script>
</body>

</html>